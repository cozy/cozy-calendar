// Generated by CoffeeScript 1.10.0
var Contact, Event, Settings, Sharing, Tag, User, WebDavAccount, async, cozydb, log, moment;

async = require('async');

moment = require('moment');

cozydb = require('cozydb');

log = require('printit')({
  date: true,
  prefix: 'calendar:client'
});

Tag = require('../models/tag');

Event = require('../models/event');

Sharing = require('../models/sharing');

Contact = require('../models/contact');

User = require('../models/user');

WebDavAccount = require('../models/webdavaccount');

Settings = require('../models/settings');

module.exports.index = function(req, res, next) {
  return async.parallel([
    function(done) {
      return Contact.all(function(err, contacts) {
        var contact, i, index, len;
        if (err) {
          return done(err);
        }
        for (index = i = 0, len = contacts.length; i < len; index = ++i) {
          contact = contacts[index];
          contacts[index] = contact.asNameAndEmails();
        }
        return done(null, contacts);
      });
    }, function(cb) {
      return Tag.byName({}, cb);
    }, function(cb) {
      return Settings.getCalAppSettings(cb);
    }, function(cb) {
      return Event.calendars(cb);
    }, function(cb) {
      var end, start;
      start = moment().startOf('month').subtract(3, 'months');
      end = moment().endOf('month').add(3, 'months');
      return Event.load(start, end, function(err, events) {
        return Event.request('reccuring', function(err, reccuringEvents) {
          return cb(null, events != null ? events.concat(reccuringEvents) : void 0);
        });
      });
    }, function(cb) {
      return Sharing.pendingBySharedDocType('event', cb);
    }, function(cb) {
      return cozydb.api.getCozyInstance(cb);
    }, function(cb) {
      return WebDavAccount.first(cb);
    }, function(cb) {
      if (User.timezone != null) {
        return cb(null, User.timezone);
      } else {
        return User.updateUser(function() {
          return cb(null, User.timezone);
        });
      }
    }
  ], function(err, results) {
    var calendars, contacts, events, instance, locale, pendingEventSharings, sanitize, settings, tags, timezone, webDavAccount;
    if (err) {
      return next(err);
    }
    contacts = results[0], tags = results[1], settings = results[2], calendars = results[3], events = results[4], pendingEventSharings = results[5], instance = results[6], webDavAccount = results[7], timezone = results[8];
    locale = (instance != null ? instance.locale : void 0) || 'en';
    if (webDavAccount != null) {
      webDavAccount.domain = (instance != null ? instance.domain : void 0) || '';
    }
    timezone = timezone || 'UTC';
    sanitize = function(obj) {
      return "JSON.parse(decodeURI(\"" + (encodeURI(JSON.stringify(obj))) + "\"));";
    };
    return res.render('index', {
      imports: "window.locale = \"" + locale + "\";\nwindow.inittags = " + (sanitize(tags)) + ";\nwindow.initcalendars = " + (sanitize(calendars)) + ";\nwindow.initevents = " + (sanitize(events)) + "\nwindow.initPendingEventSharings = " + (sanitize(pendingEventSharings)) + ";\nwindow.initcontacts = " + (sanitize(contacts)) + ";\nwindow.initsettings = " + (sanitize(settings)) + ";\nwindow.webDavAccount = " + (sanitize(webDavAccount)) + ";\nwindow.timezone = " + (sanitize(timezone)) + ";"
    });
  });
};

module.exports.logClient = function(req, res) {
  var ref;
  log.error(req.body.data);
  log.error((ref = req.body.data.error) != null ? ref.stack : void 0);
  return res.send('ok');
};
